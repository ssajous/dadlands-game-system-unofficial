name: Release

on:
  push:
    tags:
      - 'v*'

env:
  PACKAGE_ID: dadlands

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CSS
        run: npm run css

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT

      - name: Update versions and download URL
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          TAG="${{ steps.version.outputs.TAG }}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/${{ env.PACKAGE_ID }}.zip"

          # Update system.json: version and download URL
          jq --arg ver "$VERSION" --arg url "$DOWNLOAD_URL" \
            '.version = $ver | .download = $url' system.json > system.json.tmp
          mv system.json.tmp system.json

          # Update package.json: version
          jq --arg ver "$VERSION" '.version = $ver' package.json > package.json.tmp
          mv package.json.tmp package.json

          echo "Updated version to $VERSION"
          echo "Updated download URL to $DOWNLOAD_URL"

      - name: Create release archive
        run: |
          zip -r ${{ env.PACKAGE_ID }}.zip \
            system.json \
            LICENSE.txt \
            README.md \
            lang/ \
            module/ \
            styles/simple.css \
            templates/ \
            Dadlands-RPG.pdf

      - name: Create release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "${{ env.PACKAGE_ID }}.zip,system.json"
          name: "Release ${{ steps.version.outputs.TAG }}"
          generateReleaseNotes: true
          body: |
            ## Installation

            **Manifest URL:** `https://raw.githubusercontent.com/${{ github.repository }}/refs/heads/main/system.json`

            Copy the manifest URL above and paste it into Foundry VTT's "Install System" dialog.
          allowUpdates: true
          makeLatest: true

      - name: Commit release updates to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add system.json package.json
          git commit -m "Release ${{ steps.version.outputs.TAG }}"
          git push origin HEAD:main
