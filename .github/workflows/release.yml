name: Release

on:
  push:
    tags:
      - 'v*'

env:
  PACKAGE_ID: dadlands

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CSS
        run: npm run css

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT

      - name: Validate version match
        run: |
          MANIFEST_VERSION=$(jq -r '.version' system.json)
          TAG_VERSION="${{ steps.version.outputs.VERSION }}"
          if [ "$MANIFEST_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::system.json version ($MANIFEST_VERSION) does not match tag (v$TAG_VERSION)"
            exit 1
          fi

      - name: Update manifest download URL
        run: |
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG }}/${{ env.PACKAGE_ID }}.zip"
          jq --arg url "$DOWNLOAD_URL" '.download = $url' system.json > system.json.tmp
          mv system.json.tmp system.json

      - name: Create release archive
        run: |
          zip -r ${{ env.PACKAGE_ID }}.zip \
            system.json \
            LICENSE.txt \
            README.md \
            lang/ \
            module/ \
            styles/simple.css \
            templates/ \
            Dadlands-RPG.pdf

      - name: Create release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "${{ env.PACKAGE_ID }}.zip,system.json"
          name: "Release ${{ steps.version.outputs.TAG }}"
          generateReleaseNotes: true
          body: |
            ## Installation

            **Manifest URL:** `https://raw.githubusercontent.com/${{ github.repository }}/refs/heads/main/system.json`

            Copy the manifest URL above and paste it into Foundry VTT's "Install System" dialog.
          allowUpdates: true
          makeLatest: true

      - name: Commit updated system.json to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add system.json
          git commit -m "Release ${{ steps.version.outputs.TAG }}"
          git push origin HEAD:main
